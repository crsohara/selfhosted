---
- name: Ensure {{ dir.docker }}/authelia dir exists
  file: path={{ dir.docker }}/authelia state=directory

- name: Ensure {{ dir.docker }}/traefik dir exists
  file: path={{ dir.docker }}/traefik state=directory

- name: cp traefik.rules | template
  template:
    src: rules.yml
    dest: '{{ dir.docker }}/traefik/'
  notify: reboot traefik

- name: cp authelia.config | template
  template:
    src: configuration.yml
    dest: '{{ dir.docker }}/authelia/'
  notify: reboot authelia

- name: cp authelia.users_db | template
  template:
    src: users_database.yml
    dest: '{{ dir.docker }}/authelia/'
  notify: reboot authelia

- name: Create Traefik & Authelia SSO containers
  docker_compose:
    project_name: nansi_authelia
    pull: yes

    definition:
      version: '3.3'

      networks:
        traefik:
          external:
            name: traefik

      volumes:
        certificate:
          driver: local

      services:
        traefik:
          image: traefik:latest
          container_name: nansi_traefik
          restart: always
          command:
            - '--log.level=ERROR'
            - '--api=true'
            - '--api.insecure=true'
            - '--pilot.token={{ traefik.pilot.token }}'
            - '--providers.docker=true'
            - '--providers.docker.network=traefik'
            - '--providers.docker.exposedbydefault=false'
            - "--providers.file=true"
            - "--providers.file.filename=/etc/traefik/rules.yml"
            - "--providers.file.watch=true"
            - '--entrypoints.web.address=:80'
            - '--entrypoints.websecure.address=:443'
            - '--entrypoints.web.http.redirections.entryPoint.to=websecure'
            - '--entrypoints.web.http.redirections.entryPoint.scheme=https'
            - '--certificatesresolvers.tmp.acme.httpchallenge=true'
            - '--certificatesresolvers.tmp.acme.httpchallenge.entrypoint=web'
            - '--certificatesresolvers.tmp.acme.email=hello@{{ tld.base }}'
            - '--certificatesresolvers.tmp.acme.storage=/certificate/acme.json'
          labels:
            - traefik.enable=true
            - traefik.http.routers.traefik.rule=Host(`dashboard.{{ tld.home }}`)
            - traefik.http.routers.traefik.service=api@internal
            - traefik.http.routers.traefik.tls.certresolver=tmp
            - traefik.http.routers.traefik.middlewares=authelia@docker
            - traefik.http.routers.api.middlewares=authelia@docker
            - traefik.http.services.api.loadbalancer.server.port=9999
          environment:
            - TZ={{ tz }}
          ports:
            - 80:80
            - 443:443
          networks:
            - traefik
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - certificate:/certificate
            - "{{ dir.docker }}/traefik/rules.yml:/etc/traefik/rules.yml"
          extra_hosts:
            - host.docker.internal:172.17.0.1
          depends_on:
            - authelia

        authelia:
          image: authelia/authelia:latest
          container_name: nansi_authelia
          restart: always
          networks:
            - traefik
          environment:
            - TZ={{ tz }}
            - PGID=1000
            - PUID=1000
          volumes:
            - "{{ dir.docker }}/authelia:/config"
          labels:
            - traefik.enable=true
            - traefik.http.routers.authelia.rule=Host(`authelia.{{ tld.home }}`)
            - traefik.http.routers.authelia.entrypoints=websecure
            - traefik.http.routers.authelia.tls=true
            - traefik.http.routers.authelia.tls.certresolver=tmp
            - 'traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=https://authelia.{{ tld.home }}'
            - 'traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true'
            - 'traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email'
